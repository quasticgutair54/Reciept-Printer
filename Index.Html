<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System 7 Receipt Printer</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        :root {
            --phosphor-green: #39ff14;
            --crt-glow: rgba(57, 255, 20, 0.1);
            --dark-bg: #0a0a0a;
            --error-red: #ff003c;
            --future-blue: #4d4dff;
        }
        
        body {
            background: var(--dark-bg);
            color: var(--phosphor-green);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            transition: all 3s ease;
            font-weight: 500;
        }
        
        /* CRT Monitor Effect */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 6px 100%;
            z-index: 100;
            pointer-events: none;
            opacity: 0.3;
        }
        
        .crt-curvature {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            box-shadow: 
                inset 0 0 60px rgba(0, 0, 0, 0.9),
                inset 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 101;
            pointer-events: none;
        }
        
        .crt-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                var(--crt-glow) 70%,
                transparent 100%
            );
            z-index: 102;
            pointer-events: none;
            opacity: 0.15;
        }
        
        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                rgba(0, 0, 0, 0.8) 100%
            );
            z-index: 103;
            pointer-events: none;
        }
        
        body.stable .crt-overlay,
        body.stable .crt-curvature,
        body.stable .crt-glow,
        body.stable .vignette {
            opacity: 0;
            transition: opacity 2s ease;
        }
        
        body.stable {
            background: #f5f5f5;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            z-index: 10;
            position: relative;
        }
        
        .stage {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 1s ease;
        }
        
        .active {
            display: flex;
        }
        
        .receipt {
            background: #fff;
            color: #000;
            width: 100%;
            padding: 30px;
            margin: 20px 0;
            position: relative;
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.2);
            border: 1px solid #333;
            transform: perspective(1000px) rotateX(2deg);
        }
        
        .receipt::before, .receipt::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            height: 5px;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 5px,
                #000 5px,
                #000 10px
            );
        }
        
        .receipt::before {
            top: 0;
        }
        
        .receipt::after {
            bottom: 0;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px dashed #333;
            padding-bottom: 10px;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dotted #ccc;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .receipt-item:hover {
            background-color: #f5f5f5;
            padding-left: 10px;
        }
        
        .receipt-item:hover::after {
            content: "[DE-AUTHORIZE]";
            position: absolute;
            right: 10px;
            color: var(--error-red);
            opacity: 0.7;
            animation: flicker 0.5s infinite;
        }
        
        .receipt-item.crossed {
            position: relative;
            overflow: hidden;
        }
        
        .receipt-item.crossed::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--error-red);
            animation: strike 0.3s ease-out forwards;
            transform-origin: left;
        }
        
        .receipt-footer {
            margin-top: 20px;
            border-top: 2px dashed #333;
            padding-top: 10px;
            text-align: center;
        }
        
        .btn {
            background: #1a1a1a;
            color: var(--phosphor-green);
            border: 1px solid var(--phosphor-green);
            padding: 14px 28px;
            margin: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(57, 255, 20, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            background: var(--phosphor-green);
            color: #000;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.5);
        }
        
        .btn-unstable {
            animation: glitch 0.5s infinite;
            border-color: var(--error-red);
            color: var(--error-red);
        }
        
        .btn-pulse {
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
        }
        
        .message-box {
            background: rgba(57, 255, 20, 0.05);
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid var(--phosphor-green);
            width: 100%;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.1);
        }
        
        .game-container {
            width: 100%;
            height: 450px;
            background: #111;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid var(--phosphor-green);
            border-radius: 5px;
        }
        
        .basket {
            position: absolute;
            bottom: 15px;
            width: 120px;
            height: 35px;
            background: var(--phosphor-green);
            transition: left 0.1s;
            border-radius: 3px 3px 0 0;
            box-shadow: 0 -3px 10px rgba(57, 255, 20, 0.5);
        }
        
        .falling-item {
            position: absolute;
            padding: 10px;
            border-radius: 5px;
            font-size: 24px;
            text-align: center;
            transition: transform 0.1s;
            font-weight: bold;
            z-index: 5;
        }
        
        .falling-item.true-data {
            background: var(--phosphor-green);
            color: #000;
            box-shadow: 0 0 15px var(--phosphor-green);
        }
        
        .falling-item.corrupted {
            background: var(--error-red);
            color: #fff;
            box-shadow: 0 0 15px var(--error-red);
        }
        
        .falling-item.rare {
            background: gold;
            color: #000;
            box-shadow: 0 0 25px gold;
            animation: rotate 3s infinite linear, pulse 1.5s infinite;
        }
        
        .points-display {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 18px;
            font-size: 20px;
            border: 1px solid var(--phosphor-green);
            border-radius: 5px;
            z-index: 10;
        }
        
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #111;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid var(--phosphor-green);
            border-radius: 3px;
            position: relative;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--phosphor-green), #4d4dff);
            width: 0%;
            transition: width 0.5s;
            border-radius: 2px;
        }
        
        .progress-label {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 5px black;
        }
        
        .typewriter {
            overflow: hidden;
            border-right: 2px solid var(--phosphor-green);
            white-space: nowrap;
            margin: 0 auto;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }
        
        .access-denied {
            color: var(--error-red);
            animation: shake 0.5s, glitch-text 0.3s 3;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 24px;
        }
        
        .success {
            color: var(--phosphor-green);
            animation: pulse 1s;
        }
        
        .location {
            color: #ffff00;
            animation: location-glitch 0.5s;
        }
        
        .future-item {
            color: var(--future-blue);
            text-shadow: 0 0 10px var(--future-blue);
        }
        
        .ice-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, rgba(173, 216, 230, 0.9), rgba(240, 248, 255, 0.95));
            z-index: 50;
            transition: height 20s linear;
            pointer-events: none;
            opacity: 0.9;
        }
        
        .ice-overlay.active {
            height: 100%;
        }
        
        .ice-crack {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255,255,255,0.8) 1px, transparent 1px),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.6) 1px, transparent 1px),
                radial-gradient(circle at 40% 80%, rgba(255,255,255,0.7) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0;
            z-index: 51;
            pointer-events: none;
        }
        
        .ice-crack.active {
            animation: crack 0.8s forwards;
        }
        
        .questionnaire {
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border: 2px solid #4d4dff;
            border-radius: 10px;
            margin: 20px 0;
            z-index: 60;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(77, 77, 255, 0.3);
        }
        
        .question {
            margin: 20px 0;
            text-align: center;
            font-size: 22px;
        }
        
        .timer {
            font-size: 28px;
            margin: 15px 0;
            color: #ff9900;
            font-weight: bold;
            text-shadow: 0 0 10px #ff9900;
        }
        
        .calculation-terminal {
            background: #000;
            color: var(--phosphor-green);
            padding: 30px;
            border: 2px solid var(--phosphor-green);
            border-radius: 5px;
            margin: 20px 0;
            width: 100%;
            min-height: 200px;
            font-family: 'IBM Plex Mono', monospace;
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.2);
        }
        
        .terminal-line {
            margin-bottom: 10px;
            opacity: 0;
            animation: terminal-print 0.5s forwards;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes glitch {
            0% { transform: translate(0); filter: hue-rotate(0deg); }
            20% { transform: translate(-2px, 2px); filter: hue-rotate(90deg); }
            40% { transform: translate(-2px, -2px); filter: hue-rotate(180deg); }
            60% { transform: translate(2px, 2px); filter: hue-rotate(270deg); }
            80% { transform: translate(2px, -2px); filter: hue-rotate(300deg); }
            100% { transform: translate(0); filter: hue-rotate(360deg); }
        }
        
        @keyframes glitch-text {
            0% { transform: translateX(0); }
            20% { transform: translateX(-3px); }
            40% { transform: translateX(3px); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        
        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: var(--phosphor-green); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; box-shadow: 0 0 15px currentColor; }
            50% { opacity: 0.8; box-shadow: 0 0 25px currentColor; }
            100% { opacity: 1; box-shadow: 0 0 15px currentColor; }
        }
        
        @keyframes print {
            to { opacity: 1; }
        }
        
        @keyframes crack {
            0% { opacity: 0; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.2); }
        }
        
        @keyframes strike {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.3; }
        }
        
        @keyframes location-glitch {
            0% { transform: translateX(0); opacity: 1; }
            25% { transform: translateX(-5px); opacity: 0.5; }
            50% { transform: translateX(5px); opacity: 0.2; }
            75% { transform: translateX(-3px); opacity: 0.7; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes terminal-print {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        .print-line {
            opacity: 0;
            animation: print 0.5s forwards;
        }
        
        h1 {
            margin-bottom: 25px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 600;
            text-shadow: 0 0 10px var(--phosphor-green);
        }
        
        .emoji {
            font-size: 22px;
            margin: 0 5px;
        }
        
        .static {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15) 0px,
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 104;
            opacity: 0.1;
        }
        
        .static.active {
            opacity: 0.3;
            animation: staticMove 0.1s infinite;
        }
        
        @keyframes staticMove {
            0% { background-position: 0 0; }
            100% { background-position: 0 10px; }
        }
        
        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
        }
        
        .screen-flash.active {
            animation: flash 0.3s;
        }
        
        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .receipt {
                padding: 20px;
            }
            
            .game-container {
                height: 350px;
            }
            
            .question {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>
    <div class="crt-curvature"></div>
    <div class="crt-glow"></div>
    <div class="vignette"></div>
    <div class="static" id="staticOverlay"></div>
    <div class="screen-flash" id="screenFlash"></div>
    <div class="ice-overlay" id="iceOverlay"></div>
    <div class="ice-crack" id="iceCrack"></div>
    
    <div class="container">
        <!-- Stage 1: The Personal Invitation -->
        <div id="stage1" class="stage active">
            <h1>System 7 Receipt Printer</h1>
            <div class="message-box">
                <p id="welcomeMessage" class="typewriter">Searching... Entity detected. This is a System 7 Receipt Printer. You've made a purchase, and we have the record. Let's print it for you.</p>
            </div>
            <div id="printerAnimation" style="display: none;">
                <div class="receipt">
                    <div class="receipt-header">
                        <h2>SYSTEM 7 RECEIPT</h2>
                        <p>Initializing print sequence...</p>
                    </div>
                    <div id="printingLines">
                        <!-- Printing lines will be added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stage 2: The Phantom Purchase Riddle -->
        <div id="stage2" class="stage">
            <h1>System Integrity Check</h1>
            <div class="message-box">
                <p>Our records show conflicting data. De-authorize TWO phantom charges to prove you are the rightful owner.</p>
            </div>
            <div class="receipt">
                <div class="receipt-header">
                    <h2>TRANSACTION RECORD</h2>
                    <p>Account Verification Required</p>
                </div>
                
                <div class="receipt-item" data-id="1">
                    <span>Digital Soul Insurance</span>
                    <span>â‚¹9,999</span>
                </div>
                
                <div class="receipt-item" data-id="2">
                    <span>1 Dozen Eggs</span>
                    <span>â‚¹120</span>
                </div>
                
                <div class="receipt-item" data-id="3">
                    <span>A Sense of Impending Doom</span>
                    <span>â‚¹4,999</span>
                </div>
                
                <div class="receipt-item" data-id="4">
                    <span>Subscription to Reality Prime</span>
                    <span>â‚¹299/month</span>
                </div>
                
                <div class="receipt-footer">
                    <p>Select the TWO phantom charges to de-authorize</p>
                    <p>Selected: <span id="selectedCount">0</span>/2</p>
                </div>
            </div>
            <button class="btn" id="verifyBtn" disabled>Verify Selection</button>
            <div id="accessDenied" class="message-box access-denied" style="display: none;">
                <p>[ACCESS_DENIED :: ENTITY_UNKNOWN]</p>
            </div>
        </div>
        
        <!-- Stage 3: The Corrupted & Predictive Print Job -->
        <div id="stage3" class="stage">
            <h1>Printing Transaction Record</h1>
            <div class="receipt">
                <div id="corruptedPrintContent">
                    <!-- Printing content will be added here -->
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress" id="printProgress"></div>
                <div class="progress-label" id="printStatus">Initializing printer...</div>
            </div>
            <div id="corruptionMessage" class="message-box" style="display: none;">
                <p>[...memory corruption detected, <span id="clickToRestore" style="text-decoration: underline; cursor: pointer;">accessing predictive datastream...</span>...]</p>
            </div>
            <div id="reassuranceMessage" class="message-box" style="display: none;">
                <p>Apologies. We accessed the wrong timeline. Now accessing your predictive purchase history. The thing you're thinking of buying next week... or perhaps in December 2025. It's all the same to us.</p>
            </div>
        </div>
        
        <!-- Stage 4: The Glitch and The Choice -->
        <div id="stage4" class="stage">
            <h1 class="glitch">KERNEL PANIC</h1>
            <div class="message-box glitch">
                <h2>Print buffer overflow</h2>
                <p>The system is glitched.</p>
            </div>
            <button class="btn btn-unstable" id="tryAgainBtn">Try Again</button>
            <button class="btn btn-pulse" id="fixGlitchBtn">Attempt to Fix the Glitch</button>
        </div>
        
        <!-- Stage 5: The Data Recovery Mini-Game -->
        <div id="stage5" class="stage">
            <h1>System Repair Initiated</h1>
            <div class="message-box">
                <p>Catch the TRUE data fragments. Avoid corrupted files.</p>
                <p>Time: <span id="gameTime">30</span>s</p>
            </div>
            
            <div class="game-container" id="gameContainer">
                <div class="basket" id="basket"></div>
                <div class="points-display">Points: <span id="points">0</span></div>
                <!-- Falling items will be added here -->
            </div>
        </div>
        
        <!-- Stage 6: The "Frozen in Time" Questionnaire -->
        <div id="stage6" class="stage">
            <h1>SYSTEM COLD-STORAGE ACCESSED</h1>
            <div class="message-box">
                <p>CONFIRM A FUTURE INTENT TO UNLOCK LOYALTY BONUS</p>
                <p class="timer" id="questionTimer">20</p>
            </div>
            
            <div class="questionnaire" id="questionnaire">
                <!-- Questions will be added here -->
            </div>
        </div>
        
        <!-- Stage 7: The Reward Calculation -->
        <div id="stage7" class="stage">
            <h1>CALCULATING FINAL REWARD</h1>
            <div class="calculation-terminal" id="calculationTerminal">
                <!-- Calculation lines will be added here -->
            </div>
        </div>
        
        <!-- Stage 8: The Final System Sync & Redirect -->
        <div id="stage8" class="stage">
            <h1>SYSTEM SYNC</h1>
            <div class="message-box">
                <p id="syncMessage">Syncing your data... thank you for your assistance.</p>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="syncProgress"></div>
                <div class="progress-label" id="syncStatus">0%</div>
            </div>
            
            <div id="finalMessages">
                <!-- Messages will be added here -->
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="serverHum" loop>
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-server-hum-1381.mp3" type="audio/mpeg">
    </audio>
    <audio id="hardDriveClick">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-hard-drive-click-1382.mp3" type="audio/mpeg">
    </audio>
    <audio id="typeSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-typewriter-key-1383.mp3" type="audio/mpeg">
    </audio>
    <audio id="printSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-printer-scan-2772.mp3" type="audio/mpeg">
    </audio>
    <audio id="buzzerSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <audio id="successSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="glitchSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-digital-glitch-2296.mp3" type="audio/mpeg">
    </audio>
    <audio id="chimeSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-magic-sparkle-sound-3095.mp3" type="audio/mpeg">
    </audio>
    <audio id="iceSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-ice-cracking-1254.mp3" type="audio/mpeg">
    </audio>
    <audio id="shatterSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-glass-break-with-huge-splatter-2580.mp3" type="audio/mpeg">
    </audio>
    <audio id="stompSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-stomp-1384.mp3" type="audio/mpeg">
    </audio>
    <audio id="dataChirp">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-data-chirp-1385.mp3" type="audio/mpeg">
    </audio>
    <audio id="synthTone">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-synth-tone-1386.mp3" type="audio/mpeg">
    </audio>
    <audio id="windHum">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wind-hum-1387.mp3" type="audio/mpeg">
    </audio>
    <audio id="thudSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-thud-1388.mp3" type="audio/mpeg">
    </audio>
    <audio id="processingSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-data-processing-1389.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Stage management
        let currentStage = 1;
        let selectedItems = [];
        let points = 0;
        let gameInterval;
        let gameTime = 30;
        let redirectInterval;
        let tryAgainCount = 0;
        let userLocation = "Chennai"; // In a real implementation, this would be detected
        let futureIntentConfirmed = false;
        let questionnaireTimer;
        let questionTimeLeft = 20;
        
        // Correct phantom charges (items to cancel)
        const correctItems = [1, 3]; // Digital Soul Insurance and A Sense of Impending Doom
        
        // Items for the mini-game
        const gameItems = [
            { text: "+", emoji: "", type: "true" },
            { text: "+", emoji: "", type: "true" },
            { text: "+", emoji: "", type: "true" },
            { text: "+", emoji: "", type: "true" },
            { text: "X", emoji: "", type: "corrupted" },
            { text: "X", emoji: "", type: "corrupted" },
            { text: "X", emoji: "", type: "corrupted" },
            { text: "â—†", emoji: "", type: "rare" }
        ];
        
        // Questions for the questionnaire
        const questions = [
            "Confirming future purchase: A ticket to Mars?",
            "Confirming future purchase: Lifetime supply of coffee?",
            "Confirming future purchase: The ability to speak to animals?",
            "Confirming future purchase: Time travel device?",
            "Confirming future purchase: Invisibility cloak?"
        ];
        
        // DOM elements
        const welcomeMessage = document.getElementById('welcomeMessage');
        const printerAnimation = document.getElementById('printerAnimation');
        const verifyBtn = document.getElementById('verifyBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const fixGlitchBtn = document.getElementById('fixGlitchBtn');
        const selectedCount = document.getElementById('selectedCount');
        const accessDenied = document.getElementById('accessDenied');
        const pointsDisplay = document.getElementById('points');
        const gameTimeDisplay = document.getElementById('gameTime');
        const printProgress = document.getElementById('printProgress');
        const syncProgress = document.getElementById('syncProgress');
        const syncStatus = document.getElementById('syncStatus');
        const printStatus = document.getElementById('printStatus');
        const corruptedPrintContent = document.getElementById('corruptedPrintContent');
        const corruptionMessage = document.getElementById('corruptionMessage');
        const clickToRestore = document.getElementById('clickToRestore');
        const reassuranceMessage = document.getElementById('reassuranceMessage');
        const basket = document.getElementById('basket');
        const gameContainer = document.getElementById('gameContainer');
        const staticOverlay = document.getElementById('staticOverlay');
        const screenFlash = document.getElementById('screenFlash');
        const iceOverlay = document.getElementById('iceOverlay');
        const iceCrack = document.getElementById('iceCrack');
        const questionnaire = document.getElementById('questionnaire');
        const questionTimer = document.getElementById('questionTimer');
        const calculationTerminal = document.getElementById('calculationTerminal');
        const syncMessage = document.getElementById('syncMessage');
        const finalMessages = document.getElementById('finalMessages');
        
        // Audio elements
        const serverHum = document.getElementById('serverHum');
        const hardDriveClick = document.getElementById('hardDriveClick');
        const typeSound = document.getElementById('typeSound');
        const printSound = document.getElementById('printSound');
        const buzzerSound = document.getElementById('buzzerSound');
        const successSound = document.getElementById('successSound');
        const glitchSound = document.getElementById('glitchSound');
        const chimeSound = document.getElementById('chimeSound');
        const iceSound = document.getElementById('iceSound');
        const shatterSound = document.getElementById('shatterSound');
        const stompSound = document.getElementById('stompSound');
        const dataChirp = document.getElementById('dataChirp');
        const synthTone = document.getElementById('synthTone');
        const windHum = document.getElementById('windHum');
        const thudSound = document.getElementById('thudSound');
        const processingSound = document.getElementById('processingSound');
        
        // Initialize the experience
        function init() {
            // Start with server hum
            serverHum.volume = 0.3;
            serverHum.play();
            
            // Play occasional hard drive clicks
            setInterval(() => {
                if (Math.random() > 0.7) {
                    hardDriveClick.currentTime = 0;
                    hardDriveClick.play();
                }
            }, 5000);
            
            // Event listeners
            verifyBtn.addEventListener('click', verifySelection);
            tryAgainBtn.addEventListener('click', tryAgain);
            fixGlitchBtn.addEventListener('click', fixGlitch);
            clickToRestore.addEventListener('click', restorePrinting);
            
            // Add click events to receipt items
            document.querySelectorAll('.receipt-item').forEach(item => {
                item.addEventListener('mouseenter', () => {
                    // Play subtle digital tick on hover
                    typeSound.currentTime = 0;
                    typeSound.volume = 0.3;
                    typeSound.play();
                });
                
                item.addEventListener('click', toggleItemSelection);
            });
            
            // Basket movement
            document.addEventListener('mousemove', moveBasket);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') moveBasketLeft();
                if (e.key === 'ArrowRight') moveBasketRight();
            });
            
            // Start the welcome sequence
            startWelcomeSequence();
        }
        
        // Start the welcome sequence with typing effect
        function startWelcomeSequence() {
            // Play typing sound for each character
            const text = welcomeMessage.textContent;
            welcomeMessage.textContent = '';
            let i = 0;
            
            function typeWriter() {
                if (i < text.length) {
                    welcomeMessage.textContent += text.charAt(i);
                    typeSound.currentTime = 0;
                    typeSound.volume = 0.5;
                    typeSound.play();
                    i++;
                    setTimeout(typeWriter, 70);
                } else {
                    // Location glitch effect
                    setTimeout(() => {
                        const originalText = welcomeMessage.textContent;
                        welcomeMessage.textContent = 'S3@r(h1n9... 3n71t% d3t3(t3d. Th1$ 1$ @ $y$t3m 7 R3(31p+ Pr1n+3r. Y0u\'v3 m@d3 @ pur(h@s3, @nd w3 h@v3 th3 r3(0rd. L3t\'$ pr1n+ 1+ f0r y0u.';
                        
                        glitchSound.currentTime = 0;
                        glitchSound.play();
                        dataChirp.currentTime = 0;
                        dataChirp.play();
                        
                        setTimeout(() => {
                            welcomeMessage.textContent = originalText + `...Let's print it for you, user from ${userLocation}.`;
                            welcomeMessage.classList.add('location');
                            
                            setTimeout(() => {
                                welcomeMessage.classList.remove('location');
                                welcomeMessage.textContent = originalText;
                                
                                // Show printer animation after a delay
                                setTimeout(() => {
                                    printerAnimation.style.display = 'block';
                                    startPrinterAnimation();
                                }, 1000);
                            }, 800);
                        }, 500);
                    }, 1000);
                }
            }
            
            typeWriter();
        }
        
        // Simulate printer animation
        function startPrinterAnimation() {
            const printingLines = document.getElementById('printingLines');
            const lines = [
                "INITIALIZING SYSTEM 7...",
                "SCANNING ENTITY...",
                "ACCESSING TRANSACTION DATABASE...",
                "LOCATING RECORDS FOR USER...",
                "COMPILING RECEIPT DATA...",
                "READY TO PRINT."
            ];
            
            let lineIndex = 0;
            const printInterval = setInterval(() => {
                if (lineIndex < lines.length) {
                    const line = document.createElement('p');
                    line.textContent = lines[lineIndex];
                    line.classList.add('print-line');
                    printingLines.appendChild(line);
                    
                    // Play print sound
                    printSound.currentTime = 0;
                    printSound.play();
                    
                    lineIndex++;
                } else {
                    clearInterval(printInterval);
                    
                    // Move to next stage after printing is complete
                    setTimeout(() => {
                        moveToStage(2);
                    }, 2000);
                }
            }, 800);
        }
        
        // Move to specific stage
        function moveToStage(stage) {
            document.querySelectorAll('.stage').forEach(s => s.classList.remove('active'));
            document.getElementById(`stage${stage}`).classList.add('active');
            currentStage = stage;
            
            // Stage-specific initialization
            switch(stage) {
                case 2:
                    resetSelection();
                    synthTone.currentTime = 0;
                    synthTone.volume = 0.4;
                    synthTone.play();
                    break;
                case 3:
                    startCorruptedPrinting();
                    break;
                case 5:
                    startMiniGame();
                    break;
                case 6:
                    startQuestionnaire();
                    break;
                case 7:
                    calculateReward();
                    break;
                case 8:
                    startSystemSync();
                    break;
            }
        }
        
        // Toggle item selection in stage 2
        function toggleItemSelection(e) {
            const item = e.currentTarget;
            const itemId = parseInt(item.getAttribute('data-id'));
            
            if (selectedItems.includes(itemId)) {
                // Deselect item
                selectedItems = selectedItems.filter(id => id !== itemId);
                item.classList.remove('crossed');
            } else {
                // Select item (if less than 2)
                if (selectedItems.length < 2) {
                    selectedItems.push(itemId);
                    item.classList.add('crossed');
                    
                    // Play stomp sound
                    stompSound.currentTime = 0;
                    stompSound.play();
                }
            }
            
            // Update UI
            selectedCount.textContent = selectedItems.length;
            verifyBtn.disabled = selectedItems.length !== 2;
        }
        
        // Reset selection
        function resetSelection() {
            selectedItems = [];
            selectedCount.textContent = '0';
            verifyBtn.disabled = true;
            accessDenied.style.display = 'none';
            document.querySelectorAll('.receipt-item').forEach(item => {
                item.classList.remove('crossed');
            });
        }
        
        // Verify if selected items are correct
        function verifySelection() {
            // Check if selected items match the correct items
            const isCorrect = JSON.stringify(selectedItems.sort()) === JSON.stringify(correctItems.sort());
            
            if (isCorrect) {
                // Play success sound
                successSound.currentTime = 0;
                successSound.play();
                
                // Screen flash
                screenFlash.classList.add('active');
                setTimeout(() => {
                    screenFlash.classList.remove('active');
                }, 300);
                
                // Add glitch effect
                document.body.classList.add('glitch');
                setTimeout(() => {
                    document.body.classList.remove('glitch');
                }, 1000);
                
                // Move to next stage
                setTimeout(() => {
                    moveToStage(3);
                }, 1500);
            } else {
                // Play buzzer sound
                buzzerSound.currentTime = 0;
                buzzerSound.play();
                
                // Screen shake
                document.body.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 500);
                
                // Show access denied message
                accessDenied.style.display = 'block';
                
                // Reset selection after a delay
                setTimeout(() => {
                    resetSelection();
                }, 2000);
            }
        }
        
        // Start corrupted printing in stage 3
        function startCorruptedPrinting() {
            corruptedPrintContent.innerHTML = '';
            printProgress.style.width = '0%';
            printStatus.textContent = 'Initializing printer...';
            
            const normalLines = [
                "=================================",
                "         DAILY TRANSACTIONS      ",
                "=================================",
                "Milk........................â‚¹60",
                "Bread.......................â‚¹45",
                "Receipt Paper...............â‚¹120",
                "Printer Ink.................â‚¹350",
                "Batteries...................â‚¹180",
                "---------------------------------",
                "Subtotal: â‚¹755",
                "Tax: â‚¹136",
                "---------------------------------",
                "TOTAL: â‚¹891",
                "================================="
            ];
            
            const surrealLines = [
                "Neuralink Subscription (2025)....â‚¹0",
                "Anti-Gravity Boots.........â‚¹12,499",
                "A Forgotten Memory..........â‚¹N/A",
                "Time Crystal................â‚¹7,999",
                "5D Printer Cartridge.......â‚¹2,499",
                "Holographic Pet.............â‚¹3,999",
                "Dream Recorder..............â‚¹5,499",
                "ðŸ‘½ Alien Translation Service.â‚¹9,999"
            ];
            
            let lineIndex = 0;
            let isCorrupted = false;
            
            const printInterval = setInterval(() => {
                if (lineIndex < normalLines.length + surrealLines.length) {
                    const line = document.createElement('p');
                    
                    if (lineIndex < normalLines.length) {
                        line.textContent = normalLines[lineIndex];
                    } else {
                        if (!isCorrupted) {
                            // Show corruption message
                            isCorrupted = true;
                            clearInterval(printInterval);
                            corruptionMessage.style.display = 'block';
                            return;
                        }
                        line.textContent = surrealLines[lineIndex - normalLines.length];
                        line.classList.add('future-item');
                    }
                    
                    line.classList.add('print-line');
                    corruptedPrintContent.appendChild(line);
                    
                    // Scroll to bottom
                    corruptedPrintContent.parentElement.scrollTop = corruptedPrintContent.parentElement.scrollHeight;
                    
                    // Update progress
                    const progress = ((lineIndex + 1) / (normalLines.length + surrealLines.length)) * 100;
                    printProgress.style.width = `${progress}%`;
                    printStatus.textContent = `Printing... ${Math.round(progress)}%`;
                    
                    // Play print sound occasionally
                    if (lineIndex % 2 === 0) {
                        printSound.currentTime = 0;
                        printSound.play();
                    }
                    
                    lineIndex++;
                } else {
                    clearInterval(printInterval);
                    
                    // After printing is complete, show glitch message
                    setTimeout(() => {
                        moveToStage(4);
                    }, 2000);
                }
            }, 300);
        }
        
        // Restore printing after corruption
        function restorePrinting() {
            corruptionMessage.style.display = 'none';
            reassuranceMessage.style.display = 'block';
            
            // Play whoosh sound
            glitchSound.currentTime = 0;
            glitchSound.play();
            
            // Continue with surreal printing
            const surrealLines = [
                "Neuralink Subscription (2025)....â‚¹0",
                "Anti-Gravity Boots.........â‚¹12,499",
                "A Forgotten Memory..........â‚¹N/A",
                "Time Crystal................â‚¹7,999",
                "5D Printer Cartridge.......â‚¹2,499",
                "Holographic Pet.............â‚¹3,999",
                "Dream Recorder..............â‚¹5,499",
                "ðŸ‘½ Alien Translation Service.â‚¹9,999"
            ];
            
            let lineIndex = 0;
            const printInterval = setInterval(() => {
                if (lineIndex < surrealLines.length) {
                    const line = document.createElement('p');
                    line.textContent = surrealLines[lineIndex];
                    line.classList.add('print-line');
                    line.classList.add('future-item');
                    corruptedPrintContent.appendChild(line);
                    
                    // Scroll to bottom
                    corruptedPrintContent.parentElement.scrollTop = corruptedPrintContent.parentElement.scrollHeight;
                    
                    // Update progress
                    const progress = 50 + ((lineIndex + 1) / surrealLines.length) * 50;
                    printProgress.style.width = `${progress}%`;
                    printStatus.textContent = `Printing... ${Math.round(progress)}%`;
                    
                    // Play print sound occasionally
                    if (lineIndex % 2 === 0) {
                        printSound.currentTime = 0;
                        printSound.play();
                    }
                    
                    lineIndex++;
                } else {
                    clearInterval(printInterval);
                    
                    // After printing is complete, show glitch message
                    setTimeout(() => {
                        moveToStage(4);
                    }, 2000);
                }
            }, 300);
        }
        
        // Try again in stage 4
        function tryAgain() {
            tryAgainCount++;
            
            // Increase static effect with each try
            staticOverlay.classList.add('active');
            setTimeout(() => {
                staticOverlay.classList.remove('active');
            }, 1000);
            
            // Increase server hum volume
            serverHum.volume = Math.min(0.7, 0.3 + (tryAgainCount * 0.1));
            
            // Play tearing sound
            glitchSound.currentTime = 0;
            glitchSound.play();
            
            // Go back to stage 3
            moveToStage(3);
        }
        
        // Fix glitch in stage 4
        function fixGlitch() {
            moveToStage(5);
        }
        
        // Start the mini-game
        function startMiniGame() {
            points = 0;
            gameTime = 30;
            pointsDisplay.textContent = points;
            gameTimeDisplay.textContent = gameTime;
            
            // Reset basket position
            basket.style.left = '50%';
            
            // Clear any existing items
            document.querySelectorAll('.falling-item').forEach(item => item.remove());
            
            // Start generating falling items
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(createFallingItem, 800);
            
            // Game timer
            const timerInterval = setInterval(() => {
                gameTime--;
                gameTimeDisplay.textContent = gameTime;
                
                if (gameTime <= 0) {
                    clearInterval(gameInterval);
                    clearInterval(timerInterval);
                    
                    // Move to next stage
                    setTimeout(() => {
                        moveToStage(6);
                    }, 2000);
                }
            }, 1000);
        }
        
        // Create a falling item
        function createFallingItem() {
            const item = document.createElement('div');
            const randomItem = gameItems[Math.floor(Math.random() * gameItems.length)];
            
            item.textContent = randomItem.text;
            item.classList.add('falling-item');
            item.classList.add(
                randomItem.type === 'true' ? 'true-data' : 
                randomItem.type === 'rare' ? 'rare' : 'corrupted'
            );
            
            // Set random horizontal position
            const leftPos = Math.random() * (gameContainer.offsetWidth - 100);
            item.style.left = `${leftPos}px`;
            item.style.top = '-50px';
            
            gameContainer.appendChild(item);
            
            // Animate falling
            const fallInterval = setInterval(() => {
                const currentTop = parseInt(item.style.top);
                item.style.top = `${currentTop + 3}px`;
                
                // Check if item is caught by basket
                const itemRect = item.getBoundingClientRect();
                const basketRect = basket.getBoundingClientRect();
                
                if (
                    itemRect.bottom >= basketRect.top &&
                    itemRect.top <= basketRect.bottom &&
                    itemRect.right >= basketRect.left &&
                    itemRect.left <= basketRect.right
                ) {
                    // Item caught
                    clearInterval(fallInterval);
                    
                    // Visual effect - flash and dissolve
                    item.style.animation = 'pulse 0.3s';
                    setTimeout(() => {
                        item.remove();
                    }, 300);
                    
                    if (randomItem.type === 'true') {
                        points += 10;
                        pointsDisplay.textContent = points;
                        
                        // Play bloop sound
                        successSound.currentTime = 0;
                        successSound.volume = 0.5;
                        successSound.play();
                        
                        // Score counter tick
                        typeSound.currentTime = 0;
                        typeSound.volume = 0.3;
                        typeSound.play();
                    } else if (randomItem.type === 'rare') {
                        points += 50;
                        pointsDisplay.textContent = points;
                        
                        // Play triumphant chime
                        chimeSound.currentTime = 0;
                        chimeSound.play();
                    } else {
                        // Corrupted item - screen shake
                        document.body.style.animation = 'shake 0.3s';
                        setTimeout(() => {
                            document.body.style.animation = '';
                        }, 300);
                        
                        // Play buzz sound
                        buzzerSound.currentTime = 0;
                        buzzerSound.volume = 0.4;
                        buzzerSound.play();
                    }
                }
                
                // Remove if out of bounds
                if (currentTop > gameContainer.offsetHeight) {
                    clearInterval(fallInterval);
                    item.remove();
                }
            }, 20);
        }
        
        // Move basket with mouse
        function moveBasket(e) {
            if (currentStage !== 5) return;
            
            const containerRect = gameContainer.getBoundingClientRect();
            let mouseX = e.clientX - containerRect.left;
            
            // Keep basket within container bounds
            mouseX = Math.max(0, Math.min(mouseX, containerRect.width - basket.offsetWidth));
            
            basket.style.left = `${mouseX}px`;
        }
        
        // Move basket with keyboard
        function moveBasketLeft() {
            if (currentStage !== 5) return;
            
            const currentLeft = parseInt(basket.style.left) || (gameContainer.offsetWidth / 2 - basket.offsetWidth / 2);
            const newLeft = Math.max(0, currentLeft - 20);
            basket.style.left = `${newLeft}px`;
        }
        
        function moveBasketRight() {
            if (currentStage !== 5) return;
            
            const currentLeft = parseInt(basket.style.left) || (gameContainer.offsetWidth / 2 - basket.offsetWidth / 2);
            const newLeft = Math.min(gameContainer.offsetWidth - basket.offsetWidth, currentLeft + 20);
            basket.style.left = `${newLeft}px`;
        }
        
        // Start the questionnaire in stage 6
        function startQuestionnaire() {
            futureIntentConfirmed = false;
            questionTimeLeft = 20;
            questionTimer.textContent = questionTimeLeft;
            questionnaire.innerHTML = '';
            
            // Start ice effect and sound
            iceSound.play();
            windHum.play();
            iceOverlay.classList.add('active');
            
            // Display questions one by one
            let questionIndex = 0;
            const questionInterval = setInterval(() => {
                if (questionIndex < questions.length) {
                    displayQuestion(questions[questionIndex]);
                    questionIndex++;
                } else {
                    clearInterval(questionInterval);
                }
            }, 4000); // Show a new question every 4 seconds
            
            // Start timer
            questionnaireTimer = setInterval(() => {
                questionTimeLeft--;
                questionTimer.textContent = questionTimeLeft;
                
                if (questionTimeLeft <= 0) {
                    clearInterval(questionnaireTimer);
                    endQuestionnaire();
                }
            }, 1000);
        }
        
        // Display a single question
        function displayQuestion(questionText) {
            // Clear previous question
            questionnaire.innerHTML = '';
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            
            const questionP = document.createElement('p');
            questionP.textContent = questionText;
            questionDiv.appendChild(questionP);
            
            const yesBtn = document.createElement('button');
            yesBtn.className = 'btn';
            yesBtn.textContent = 'Yes';
            yesBtn.addEventListener('click', () => {
                futureIntentConfirmed = true;
                endQuestionnaire();
            });
            
            const noBtn = document.createElement('button');
            noBtn.className = 'btn';
            noBtn.textContent = 'No';
            noBtn.addEventListener('click', () => {
                // Just continue to next question
            });
            
            questionDiv.appendChild(yesBtn);
            questionDiv.appendChild(noBtn);
            
            questionnaire.appendChild(questionDiv);
            
            // Play thud sound for new question
            thudSound.currentTime = 0;
            thudSound.play();
        }
        
        // End the questionnaire
        function endQuestionnaire() {
            clearInterval(questionnaireTimer);
            windHum.pause();
            
            if (futureIntentConfirmed) {
                // Ice shatters
                iceSound.pause();
                shatterSound.play();
                iceCrack.classList.add('active');
                
                // Screen flash
                screenFlash.classList.add('active');
                setTimeout(() => {
                    screenFlash.classList.remove('active');
                }, 300);
                
                setTimeout(() => {
                    iceOverlay.classList.remove('active');
                    iceCrack.classList.remove('active');
                    
                    // Move to next stage
                    setTimeout(() => {
                        moveToStage(7);
                    }, 1000);
                }, 1000);
            } else {
                // Screen freezes completely
                setTimeout(() => {
                    document.body.style.filter = 'blur(5px) grayscale(50%)';
                    
                    setTimeout(() => {
                        document.body.style.filter = 'none';
                        iceOverlay.classList.remove('active');
                        
                        // Play failure tone
                        buzzerSound.currentTime = 0;
                        buzzerSound.volume = 0.3;
                        buzzerSound.play();
                        
                        // Move to next stage
                        moveToStage(7);
                    }, 1500);
                }, 1000);
            }
        }
        
        // Calculate and display reward in stage 7
        function calculateReward() {
            calculationTerminal.innerHTML = '';
            
            // Start processing sound
            processingSound.play();
            
            // Add blinking cursor
            const cursorLine = document.createElement('div');
            cursorLine.className = 'terminal-line blink';
            cursorLine.textContent = 'CALCULATING...';
            calculationTerminal.appendChild(cursorLine);
            
            setTimeout(() => {
                // Remove blinking cursor
                cursorLine.classList.remove('blink');
                
                // Add data fragments line
                const fragmentsLine = document.createElement('div');
                fragmentsLine.className = 'terminal-line';
                fragmentsLine.textContent = `DATA FRAGMENTS RECOVERED: +${points}`;
                calculationTerminal.appendChild(fragmentsLine);
                
                // Simulate number ticking
                let displayPoints = 0;
                const pointsInterval = setInterval(() => {
                    displayPoints += Math.ceil(points / 10);
                    if (displayPoints >= points) {
                        displayPoints = points;
                        clearInterval(pointsInterval);
                        
                        setTimeout(() => {
                            // Add loyalty bonus line
                            const bonusLine = document.createElement('div');
                            bonusLine.className = 'terminal-line';
                            
                            if (futureIntentConfirmed) {
                                bonusLine.textContent = 'LOYALTY BONUS: [CONFIRMED]';
                                bonusLine.classList.add('success');
                            } else {
                                bonusLine.textContent = 'LOYALTY BONUS: [DENIED]';
                            }
                            
                            calculationTerminal.appendChild(bonusLine);
                            
                            setTimeout(() => {
                                // Add final reward line
                                const rewardLine = document.createElement('div');
                                rewardLine.className = 'terminal-line';
                                
                                if (futureIntentConfirmed) {
                                    rewardLine.textContent = 'FINAL REWARD: 30% System Credit Applied.';
                                    rewardLine.classList.add('success');
                                    
                                    // Play success chime
                                    successSound.currentTime = 0;
                                    successSound.play();
                                } else {
                                    rewardLine.textContent = 'FINAL REWARD: 0.1% Standard Rebate Applied.';
                                    
                                    // Play muted beep
                                    typeSound.currentTime = 0;
                                    typeSound.volume = 0.2;
                                    typeSound.play();
                                }
                                
                                calculationTerminal.appendChild(rewardLine);
                                
                                // Stop processing sound
                                processingSound.pause();
                                
                                // Move to next stage after a delay
                                setTimeout(() => {
                                    moveToStage(8);
                                }, 3000);
                            }, 1000);
                        }, 1000);
                    } else {
                        fragmentsLine.textContent = `DATA FRAGMENTS RECOVERED: +${displayPoints}`;
                    }
                }, 50);
            }, 1500);
        }
        
        // Start system sync in stage 8
        function startSystemSync() {
            let syncProgressValue = 0;
            const syncInterval = setInterval(() => {
                syncProgressValue += 0.5;
                syncProgress.style.width = `${syncProgressValue}%`;
                syncStatus.textContent = `${Math.round(syncProgressValue)}%`;
                
                // Update messages based on progress
                if (syncProgressValue < 25) {
                    syncMessage.textContent = futureIntentConfirmed ? 
                        "Syncing your 30% discount... a wise choice." : 
                        "Applying your... generous 0.1% rebate. Every little bit helps.";
                } else if (syncProgressValue < 50) {
                    syncMessage.textContent = "You've been here a while. We appreciate your... cooperation.";
                } else if (syncProgressValue < 75) {
                    syncMessage.textContent = "The system is now stable. Feel free to browse our actual products.";
                } else {
                    syncMessage.textContent = "Finalizing your reality... please hold.";
                }
                
                // Gradually reduce glitch effects and transition to clean design
                if (syncProgressValue > 30) {
                    staticOverlay.style.opacity = Math.max(0, 0.1 - (syncProgressValue - 30) / 140);
                }
                
                if (syncProgressValue > 50) {
                    serverHum.volume = Math.max(0, 0.3 - (syncProgressValue - 50) / 100);
                }
                
                if (syncProgressValue > 70) {
                    document.body.classList.add('stable');
                }
                
                if (syncProgressValue >= 100) {
                    clearInterval(syncInterval);
                    serverHum.pause();
                    
                    // Show final message and redirect
                    setTimeout(() => {
                        document.getElementById('stage8').innerHTML = `
                            <h1 style="font-family: 'Segoe UI', sans-serif; color: #333;">SYNC COMPLETE</h1>
                            <div class="message-box" style="background: rgba(0,0,0,0.05); border-color: #333; color: #333;">
                                <p>Thank you for your participation.</p>
                                <p>Redirecting to our store...</p>
                            </div>
                        `;
                        
                        // In a real implementation, this would redirect to your website
                        setTimeout(() => {
                            alert("Redirecting to https://notthebestplacetobuystuff.in...");
                            // window.location.href = "https://notthebestplacetobuystuff.in";
                        }, 2000);
                    }, 1000);
                }
            }, 100);
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>

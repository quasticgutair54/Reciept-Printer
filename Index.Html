<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System 7 Receipt Printer</title>
    <link href="https://fonts.googleapis.com/css2?family=Courier+New:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background: #0a0a0a;
            color: #00ff00;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            transition: all 2s ease;
        }
        
        body.stable {
            background: #f0f0f0;
            color: #333;
            font-family: Arial, sans-serif;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            z-index: 10;
        }
        
        .stage {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 1s ease;
        }
        
        .active {
            display: flex;
        }
        
        .receipt {
            background: #fff;
            color: #000;
            width: 100%;
            padding: 25px;
            margin: 20px 0;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            border: 1px solid #333;
        }
        
        .receipt::before, .receipt::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            height: 5px;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 5px,
                #000 5px,
                #000 10px
            );
        }
        
        .receipt::before {
            top: 0;
        }
        
        .receipt::after {
            bottom: 0;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px dashed #333;
            padding-bottom: 10px;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .receipt-item:hover {
            background-color: #f5f5f5;
            padding-left: 10px;
        }
        
        .receipt-item.crossed {
            text-decoration: line-through;
            color: #999;
            background-color: #f9f9f9;
        }
        
        .receipt-footer {
            margin-top: 20px;
            border-top: 2px dashed #333;
            padding-top: 10px;
            text-align: center;
        }
        
        .btn {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 12px 25px;
            margin: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            background: #00ff00;
            color: #000;
        }
        
        .message-box {
            background: rgba(0, 255, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #00ff00;
            width: 100%;
        }
        
        .game-container {
            width: 100%;
            height: 400px;
            background: #111;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid #00ff00;
        }
        
        .basket {
            position: absolute;
            bottom: 10px;
            width: 100px;
            height: 30px;
            background: #00ff00;
            transition: left 0.1s;
        }
        
        .falling-item {
            position: absolute;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
            transition: transform 0.1s;
        }
        
        .falling-item.true-data {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .falling-item.corrupted {
            background: #ff0000;
            color: #fff;
            box-shadow: 0 0 10px #ff0000;
        }
        
        .falling-item.rare {
            background: gold;
            color: #000;
            box-shadow: 0 0 20px gold;
            animation: pulse 1s infinite;
        }
        
        .points-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            font-size: 18px;
            border: 1px solid #00ff00;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #111;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid #00ff00;
        }
        
        .progress {
            height: 100%;
            background: #00ff00;
            width: 0%;
            transition: width 0.5s;
        }
        
        .glitch {
            animation: glitch 1s infinite;
        }
        
        .typewriter {
            overflow: hidden;
            border-right: 2px solid #00ff00;
            white-space: nowrap;
            margin: 0 auto;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }
        
        .access-denied {
            color: #ff0000;
            animation: shake 0.5s;
            text-transform: uppercase;
        }
        
        .success {
            color: #00ff00;
            animation: pulse 1s;
        }
        
        .location {
            color: #ffff00;
        }
        
        .ice-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, rgba(173, 216, 230, 0.8), rgba(240, 248, 255, 0.9));
            z-index: 5;
            transition: height 5s linear;
            pointer-events: none;
        }
        
        .ice-overlay.active {
            height: 100%;
        }
        
        .ice-crack {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M10,10 L90,90 M30,10 L70,90 M50,10 L50,90 M10,30 L90,70 M10,50 L90,50" stroke="white" stroke-width="2" fill="none" /></svg>');
            opacity: 0;
            z-index: 6;
            pointer-events: none;
        }
        
        .ice-crack.active {
            animation: crack 0.5s forwards;
        }
        
        .questionnaire {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border: 2px solid #00aaff;
            border-radius: 10px;
            margin: 20px 0;
            z-index: 10;
        }
        
        .question {
            margin: 15px 0;
            text-align: center;
        }
        
        .timer {
            font-size: 24px;
            margin: 10px 0;
            color: #ff9900;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        
        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #00ff00; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @keyframes print {
            to { opacity: 1; }
        }
        
        @keyframes crack {
            0% { opacity: 0; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.2); }
        }
        
        .print-line {
            opacity: 0;
            animation: print 0.5s forwards;
        }
        
        h1 {
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .emoji {
            font-size: 20px;
            margin: 0 5px;
        }
        
        .static {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15) 0px,
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 100;
            opacity: 0.1;
        }
        
        .static.active {
            opacity: 0.3;
            animation: staticMove 0.1s infinite;
        }
        
        @keyframes staticMove {
            0% { background-position: 0 0; }
            100% { background-position: 0 10px; }
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .receipt {
                padding: 15px;
            }
            
            .game-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="static" id="staticOverlay"></div>
    <div class="ice-overlay" id="iceOverlay"></div>
    <div class="ice-crack" id="iceCrack"></div>
    
    <div class="container">
        <!-- Stage 1: The Personal Invitation -->
        <div id="stage1" class="stage active">
            <h1>System 7 Receipt Printer</h1>
            <div class="message-box">
                <p id="welcomeMessage" class="typewriter">Searching... Entity detected. This is a System 7 Receipt Printer. You've made a purchase, and we have the record. Let's print it for you.</p>
            </div>
            <div id="printerAnimation" style="display: none;">
                <div class="receipt">
                    <div class="receipt-header">
                        <h2>SYSTEM 7 RECEIPT</h2>
                        <p>Initializing print sequence...</p>
                    </div>
                    <div id="printingLines">
                        <!-- Printing lines will be added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stage 2: The Phantom Purchase Riddle -->
        <div id="stage2" class="stage">
            <h1>System Integrity Check</h1>
            <div class="message-box">
                <p>Our records show conflicting data. De-authorize TWO phantom charges to prove you are the rightful owner.</p>
            </div>
            <div class="receipt">
                <div class="receipt-header">
                    <h2>TRANSACTION RECORD</h2>
                    <p>Account Verification Required</p>
                </div>
                
                <div class="receipt-item" data-id="1">
                    <span>Digital Soul Insurance</span>
                    <span>â‚¹9,999</span>
                </div>
                
                <div class="receipt-item" data-id="2">
                    <span>1 Dozen Eggs</span>
                    <span>â‚¹120</span>
                </div>
                
                <div class="receipt-item" data-id="3">
                    <span>A Sense of Impending Doom</span>
                    <span>â‚¹4,999</span>
                </div>
                
                <div class="receipt-item" data-id="4">
                    <span>Subscription to Reality Prime</span>
                    <span>â‚¹299/month</span>
                </div>
                
                <div class="receipt-footer">
                    <p>Select the TWO phantom charges to de-authorize</p>
                    <p>Selected: <span id="selectedCount">0</span>/2</p>
                </div>
            </div>
            <button class="btn" id="verifyBtn" disabled>Verify Selection</button>
            <div id="accessDenied" class="message-box access-denied" style="display: none;">
                <p>[ACCESS_DENIED :: ENTITY_UNKNOWN]</p>
            </div>
        </div>
        
        <!-- Stage 3: The Corrupted & Predictive Print Job -->
        <div id="stage3" class="stage">
            <h1>Printing Transaction Record</h1>
            <div class="receipt">
                <div id="corruptedPrintContent">
                    <!-- Printing content will be added here -->
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress" id="printProgress"></div>
            </div>
            <p id="printStatus">Initializing printer...</p>
            <div id="corruptionMessage" class="message-box" style="display: none;">
                <p>[...memory corruption detected, <span id="clickToRestore" style="text-decoration: underline; cursor: pointer;">accessing predictive datastream...</span>...]</p>
            </div>
            <div id="reassuranceMessage" class="message-box" style="display: none;">
                <p>Apologies. We accessed the wrong timeline. Now accessing your predictive purchase history. The thing you're thinking of buying next week... or perhaps in December 2025. It's all the same to us.</p>
            </div>
        </div>
        
        <!-- Stage 4: The Glitch and The Choice -->
        <div id="stage4" class="stage">
            <h1 class="glitch">KERNEL PANIC</h1>
            <div class="message-box glitch">
                <h2>Print buffer overflow</h2>
                <p>The system is glitched.</p>
            </div>
            <button class="btn" id="tryAgainBtn">Try Again</button>
            <button class="btn" id="fixGlitchBtn">Attempt to Fix the Glitch</button>
        </div>
        
        <!-- Stage 5: The Data Recovery Mini-Game -->
        <div id="stage5" class="stage">
            <h1>System Repair Initiated</h1>
            <div class="message-box">
                <p>Catch the TRUE data fragments. Avoid corrupted files.</p>
                <p>Time: <span id="gameTime">30</span>s</p>
            </div>
            
            <div class="game-container" id="gameContainer">
                <div class="basket" id="basket"></div>
                <div class="points-display">Points: <span id="points">0</span></div>
                <!-- Falling items will be added here -->
            </div>
        </div>
        
        <!-- Stage 6: The "Frozen in Time" Questionnaire -->
        <div id="stage6" class="stage">
            <h1>SYSTEM COLD-STORAGE ACCESSED</h1>
            <div class="message-box">
                <p>CONFIRM A FUTURE INTENT TO UNLOCK LOYALTY BONUS</p>
                <p class="timer" id="questionTimer">20</p>
            </div>
            
            <div class="questionnaire" id="questionnaire">
                <!-- Questions will be added here -->
            </div>
        </div>
        
        <!-- Stage 7: The Reward Calculation -->
        <div id="stage7" class="stage">
            <h1>CALCULATING FINAL REWARD</h1>
            <div class="receipt">
                <div class="receipt-header">
                    <h2>LOYALTY REWARD CALCULATION</h2>
                </div>
                
                <div class="receipt-item">
                    <span>Data Fragments Recovered</span>
                    <span>+<span id="finalScore">0</span> points</span>
                </div>
                
                <div class="receipt-item" id="futureIntentItem" style="display: none;">
                    <span>Future Intent Confirmed</span>
                    <span>30% LOYALTY BONUS UNLOCKED</span>
                </div>
                
                <div class="receipt-item" id="standardRebateItem" style="display: none;">
                    <span>Future Intent Unconfirmed</span>
                    <span>Standard 0.1% Rebate Applied</span>
                </div>
                
                <div class="receipt-footer">
                    <p id="rewardMessage">Calculating your final reward...</p>
                </div>
            </div>
        </div>
        
        <!-- Stage 8: The Final System Sync & Redirect -->
        <div id="stage8" class="stage">
            <h1>SYSTEM SYNC</h1>
            <div class="message-box">
                <p id="syncMessage">Syncing your data... thank you for your assistance.</p>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="syncProgress"></div>
            </div>
            
            <div id="finalMessages">
                <!-- Messages will be added here -->
            </div>
            
            <p>Redirecting in <span id="countdown">5</span> seconds...</p>
        </div>
    </div>

    <audio id="fanSound" loop>
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-computer-fan-noise-1381.mp3" type="audio/mpeg">
    </audio>
    <audio id="printSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-printer-scan-2772.mp3" type="audio/mpeg">
    </audio>
    <audio id="buzzerSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <audio id="successSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="glitchSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-digital-glitch-2296.mp3" type="audio/mpeg">
    </audio>
    <audio id="chimeSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-magic-sparkle-sound-3095.mp3" type="audio/mpeg">
    </audio>
    <audio id="iceSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-ice-cracking-1254.mp3" type="audio/mpeg">
    </audio>
    <audio id="shatterSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-glass-break-with-huge-splatter-2580.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Stage management
        let currentStage = 1;
        let selectedItems = [];
        let points = 0;
        let gameInterval;
        let gameTime = 30;
        let redirectInterval;
        let tryAgainCount = 0;
        let userLocation = "Chennai"; // In a real implementation, this would be detected
        let futureIntentConfirmed = false;
        let questionnaireTimer;
        let questionTimeLeft = 20;
        
        // Correct phantom charges (items to cancel)
        const correctItems = [1, 3]; // Digital Soul Insurance and A Sense of Impending Doom
        
        // Items for the mini-game
        const gameItems = [
            { text: "Productivity Chip", emoji: "ðŸ’¾", type: "true" },
            { text: "Focus Bean", emoji: "ðŸ”®", type: "true" },
            { text: "Memory Boost", emoji: "ðŸ§ ", type: "true" },
            { text: "Clarity Module", emoji: "ðŸ’Ž", type: "true" },
            { text: "Existential Dread", emoji: "ðŸ˜±", type: "corrupted" },
            { text: "Lag Spike", emoji: "âš¡", type: "corrupted" },
            { text: "Data Corruption", emoji: "ðŸ’¥", type: "corrupted" },
            { text: "System Error", emoji: "âŒ", type: "corrupted" },
            { text: "TRUE_SELF_FRAGMENT", emoji: "â­", type: "rare" }
        ];
        
        // Questions for the questionnaire
        const questions = [
            "Confirming future purchase: A ticket to Mars?",
            "Confirming future purchase: Lifetime supply of coffee?",
            "Confirming future purchase: The ability to speak to animals?",
            "Confirming future purchase: Time travel device?",
            "Confirming future purchase: Invisibility cloak?"
        ];
        
        // DOM elements
        const welcomeMessage = document.getElementById('welcomeMessage');
        const printerAnimation = document.getElementById('printerAnimation');
        const verifyBtn = document.getElementById('verifyBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const fixGlitchBtn = document.getElementById('fixGlitchBtn');
        const selectedCount = document.getElementById('selectedCount');
        const accessDenied = document.getElementById('accessDenied');
        const pointsDisplay = document.getElementById('points');
        const gameTimeDisplay = document.getElementById('gameTime');
        const countdownDisplay = document.getElementById('countdown');
        const printProgress = document.getElementById('printProgress');
        const syncProgress = document.getElementById('syncProgress');
        const printStatus = document.getElementById('printStatus');
        const corruptedPrintContent = document.getElementById('corruptedPrintContent');
        const corruptionMessage = document.getElementById('corruptionMessage');
        const clickToRestore = document.getElementById('clickToRestore');
        const reassuranceMessage = document.getElementById('reassuranceMessage');
        const basket = document.getElementById('basket');
        const gameContainer = document.getElementById('gameContainer');
        const staticOverlay = document.getElementById('staticOverlay');
        const iceOverlay = document.getElementById('iceOverlay');
        const iceCrack = document.getElementById('iceCrack');
        const questionnaire = document.getElementById('questionnaire');
        const questionTimer = document.getElementById('questionTimer');
        const finalScore = document.getElementById('finalScore');
        const futureIntentItem = document.getElementById('futureIntentItem');
        const standardRebateItem = document.getElementById('standardRebateItem');
        const rewardMessage = document.getElementById('rewardMessage');
        const syncMessage = document.getElementById('syncMessage');
        const finalMessages = document.getElementById('finalMessages');
        
        // Audio elements
        const fanSound = document.getElementById('fanSound');
        const printSound = document.getElementById('printSound');
        const buzzerSound = document.getElementById('buzzerSound');
        const successSound = document.getElementById('successSound');
        const glitchSound = document.getElementById('glitchSound');
        const chimeSound = document.getElementById('chimeSound');
        const iceSound = document.getElementById('iceSound');
        const shatterSound = document.getElementById('shatterSound');
        
        // Initialize the experience
        function init() {
            // Start with fan sound
            fanSound.volume = 0.3;
            fanSound.play();
            
            // Event listeners
            verifyBtn.addEventListener('click', verifySelection);
            tryAgainBtn.addEventListener('click', tryAgain);
            fixGlitchBtn.addEventListener('click', fixGlitch);
            clickToRestore.addEventListener('click', restorePrinting);
            
            // Add click events to receipt items
            document.querySelectorAll('.receipt-item').forEach(item => {
                item.addEventListener('click', toggleItemSelection);
            });
            
            // Basket movement
            document.addEventListener('mousemove', moveBasket);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') moveBasketLeft();
                if (e.key === 'ArrowRight') moveBasketRight();
            });
            
            // Start the welcome sequence
            startWelcomeSequence();
        }
        
        // Start the welcome sequence with typing effect
        function startWelcomeSequence() {
            setTimeout(() => {
                // Add personal location after initial message
                const locationMessage = document.createElement('span');
                locationMessage.textContent = `...Let's print it for you, user from ${userLocation}.`;
                locationMessage.className = 'location';
                welcomeMessage.appendChild(locationMessage);
                
                // Show printer animation after a delay
                setTimeout(() => {
                    printerAnimation.style.display = 'block';
                    startPrinterAnimation();
                }, 2000);
            }, 4000);
        }
        
        // Simulate printer animation
        function startPrinterAnimation() {
            const printingLines = document.getElementById('printingLines');
            const lines = [
                "INITIALIZING SYSTEM 7...",
                "SCANNING ENTITY...",
                "ACCESSING TRANSACTION DATABASE...",
                "LOCATING RECORDS FOR USER...",
                "COMPILING RECEIPT DATA...",
                "READY TO PRINT."
            ];
            
            let lineIndex = 0;
            const printInterval = setInterval(() => {
                if (lineIndex < lines.length) {
                    const line = document.createElement('p');
                    line.textContent = lines[lineIndex];
                    line.classList.add('print-line');
                    printingLines.appendChild(line);
                    
                    // Play print sound
                    printSound.currentTime = 0;
                    printSound.play();
                    
                    lineIndex++;
                } else {
                    clearInterval(printInterval);
                    
                    // Move to next stage after printing is complete
                    setTimeout(() => {
                        moveToStage(2);
                    }, 2000);
                }
            }, 800);
        }
        
        // Move to specific stage
        function moveToStage(stage) {
            document.querySelectorAll('.stage').forEach(s => s.classList.remove('active'));
            document.getElementById(`stage${stage}`).classList.add('active');
            currentStage = stage;
            
            // Stage-specific initialization
            switch(stage) {
                case 2:
                    resetSelection();
                    break;
                case 3:
                    startCorruptedPrinting();
                    break;
                case 5:
                    startMiniGame();
                    break;
                case 6:
                    startQuestionnaire();
                    break;
                case 7:
                    calculateReward();
                    break;
                case 8:
                    startSystemSync();
                    break;
            }
        }
        
        // Toggle item selection in stage 2
        function toggleItemSelection(e) {
            const item = e.currentTarget;
            const itemId = parseInt(item.getAttribute('data-id'));
            
            if (selectedItems.includes(itemId)) {
                // Deselect item
                selectedItems = selectedItems.filter(id => id !== itemId);
                item.classList.remove('crossed');
            } else {
                // Select item (if less than 2)
                if (selectedItems.length < 2) {
                    selectedItems.push(itemId);
                    item.classList.add('crossed');
                }
            }
            
            // Update UI
            selectedCount.textContent = selectedItems.length;
            verifyBtn.disabled = selectedItems.length !== 2;
        }
        
        // Reset selection
        function resetSelection() {
            selectedItems = [];
            selectedCount.textContent = '0';
            verifyBtn.disabled = true;
            accessDenied.style.display = 'none';
            document.querySelectorAll('.receipt-item').forEach(item => {
                item.classList.remove('crossed');
            });
        }
        
        // Verify if selected items are correct
        function verifySelection() {
            // Check if selected items match the correct items
            const isCorrect = JSON.stringify(selectedItems.sort()) === JSON.stringify(correctItems.sort());
            
            if (isCorrect) {
                // Play success sound
                successSound.play();
                
                // Add glitch effect
                document.body.classList.add('glitch');
                setTimeout(() => {
                    document.body.classList.remove('glitch');
                }, 1000);
                
                // Move to next stage
                setTimeout(() => {
                    moveToStage(3);
                }, 1500);
            } else {
                // Play buzzer sound
                buzzerSound.play();
                
                // Show access denied message
                accessDenied.style.display = 'block';
                
                // Reset selection after a delay
                setTimeout(() => {
                    resetSelection();
                }, 2000);
            }
        }
        
        // Start corrupted printing in stage 3
        function startCorruptedPrinting() {
            corruptedPrintContent.innerHTML = '';
            printProgress.style.width = '0%';
            printStatus.textContent = 'Initializing printer...';
            
            const normalLines = [
                "=================================",
                "         DAILY TRANSACTIONS      ",
                "=================================",
                "Milk........................â‚¹60",
                "Bread.......................â‚¹45",
                "Receipt Paper...............â‚¹120",
                "Printer Ink.................â‚¹350",
                "Batteries...................â‚¹180",
                "---------------------------------",
                "Subtotal: â‚¹755",
                "Tax: â‚¹136",
                "---------------------------------",
                "TOTAL: â‚¹891",
                "================================="
            ];
            
            const surrealLines = [
                "Neuralink Subscription (Trial)..â‚¹0",
                "Anti-Gravity Boots.........â‚¹12,499",
                "A Forgotten Memory..........â‚¹N/A",
                "Time Crystal................â‚¹7,999",
                "5D Printer Cartridge.......â‚¹2,499",
                "Holographic Pet.............â‚¹3,999",
                "Dream Recorder..............â‚¹5,499",
                "ðŸ‘½ Alien Translation Service.â‚¹9,999"
            ];
            
            let lineIndex = 0;
            let isCorrupted = false;
            
            const printInterval = setInterval(() => {
                if (lineIndex < normalLines.length + surrealLines.length) {
                    const line = document.createElement('p');
                    
                    if (lineIndex < normalLines.length) {
                        line.textContent = normalLines[lineIndex];
                    } else {
                        if (!isCorrupted) {
                            // Show corruption message
                            isCorrupted = true;
                            clearInterval(printInterval);
                            corruptionMessage.style.display = 'block';
                            return;
                        }
                        line.textContent = surrealLines[lineIndex - normalLines.length];
                    }
                    
                    line.classList.add('print-line');
                    corruptedPrintContent.appendChild(line);
                    
                    // Scroll to bottom
                    corruptedPrintContent.parentElement.scrollTop = corruptedPrintContent.parentElement.scrollHeight;
                    
                    // Update progress
                    const progress = ((lineIndex + 1) / (normalLines.length + surrealLines.length)) * 100;
                    printProgress.style.width = `${progress}%`;
                    printStatus.textContent = `Printing... ${Math.round(progress)}%`;
                    
                    // Play print sound occasionally
                    if (lineIndex % 2 === 0) {
                        printSound.currentTime = 0;
                        printSound.play();
                    }
                    
                    lineIndex++;
                } else {
                    clearInterval(printInterval);
                    
                    // After printing is complete, show glitch message
                    setTimeout(() => {
                        moveToStage(4);
                    }, 2000);
                }
            }, 300);
        }
        
        // Restore printing after corruption
        function restorePrinting() {
            corruptionMessage.style.display = 'none';
            reassuranceMessage.style.display = 'block';
            
            // Continue with surreal printing
            const surrealLines = [
                "Neuralink Subscription (Trial)..â‚¹0",
                "Anti-Gravity Boots.........â‚¹12,499",
                "A Forgotten Memory..........â‚¹N/A",
                "Time Crystal................â‚¹7,999",
                "5D Printer Cartridge.......â‚¹2,499",
                "Holographic Pet.............â‚¹3,999",
                "Dream Recorder..............â‚¹5,499",
                "ðŸ‘½ Alien Translation Service.â‚¹9,999"
            ];
            
            let lineIndex = 0;
            const printInterval = setInterval(() => {
                if (lineIndex < surrealLines.length) {
                    const line = document.createElement('p');
                    line.textContent = surrealLines[lineIndex];
                    line.classList.add('print-line');
                    corruptedPrintContent.appendChild(line);
                    
                    // Scroll to bottom
                    corruptedPrintContent.parentElement.scrollTop = corruptedPrintContent.parentElement.scrollHeight;
                    
                    // Update progress
                    const progress = 50 + ((lineIndex + 1) / surrealLines.length) * 50;
                    printProgress.style.width = `${progress}%`;
                    printStatus.textContent = `Printing... ${Math.round(progress)}%`;
                    
                    // Play print sound occasionally
                    if (lineIndex % 2 === 0) {
                        printSound.currentTime = 0;
                        printSound.play();
                    }
                    
                    lineIndex++;
                } else {
                    clearInterval(printInterval);
                    
                    // After printing is complete, show glitch message
                    setTimeout(() => {
                        moveToStage(4);
                    }, 2000);
                }
            }, 300);
        }
        
        // Try again in stage 4
        function tryAgain() {
            tryAgainCount++;
            
            // Increase static effect with each try
            staticOverlay.classList.add('active');
            setTimeout(() => {
                staticOverlay.classList.remove('active');
            }, 1000);
            
            // Increase fan sound volume
            fanSound.volume = Math.min(0.7, 0.3 + (tryAgainCount * 0.1));
            
            // Go back to stage 3
            moveToStage(3);
        }
        
        // Fix glitch in stage 4
        function fixGlitch() {
            moveToStage(5);
        }
        
        // Start the mini-game
        function startMiniGame() {
            points = 0;
            gameTime = 30;
            pointsDisplay.textContent = points;
            gameTimeDisplay.textContent = gameTime;
            
            // Reset basket position
            basket.style.left = '50%';
            
            // Clear any existing items
            document.querySelectorAll('.falling-item').forEach(item => item.remove());
            
            // Start generating falling items
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(createFallingItem, 800);
            
            // Game timer
            const timerInterval = setInterval(() => {
                gameTime--;
                gameTimeDisplay.textContent = gameTime;
                
                if (gameTime <= 0) {
                    clearInterval(gameInterval);
                    clearInterval(timerInterval);
                    
                    // Move to next stage
                    setTimeout(() => {
                        moveToStage(6);
                    }, 2000);
                }
            }, 1000);
        }
        
        // Create a falling item
        function createFallingItem() {
            const item = document.createElement('div');
            const randomItem = gameItems[Math.floor(Math.random() * gameItems.length)];
            
            item.textContent = `${randomItem.text} ${randomItem.emoji}`;
            item.classList.add('falling-item');
            item.classList.add(
                randomItem.type === 'true' ? 'true-data' : 
                randomItem.type === 'rare' ? 'rare' : 'corrupted'
            );
            
            // Set random horizontal position
            const leftPos = Math.random() * (gameContainer.offsetWidth - 100);
            item.style.left = `${leftPos}px`;
            item.style.top = '-50px';
            
            gameContainer.appendChild(item);
            
            // Animate falling
            const fallInterval = setInterval(() => {
                const currentTop = parseInt(item.style.top);
                item.style.top = `${currentTop + 3}px`;
                
                // Check if item is caught by basket
                const itemRect = item.getBoundingClientRect();
                const basketRect = basket.getBoundingClientRect();
                
                if (
                    itemRect.bottom >= basketRect.top &&
                    itemRect.top <= basketRect.bottom &&
                    itemRect.right >= basketRect.left &&
                    itemRect.left <= basketRect.right
                ) {
                    // Item caught
                    clearInterval(fallInterval);
                    item.remove();
                    
                    if (randomItem.type === 'true') {
                        points += 10;
                        pointsDisplay.textContent = points;
                        successSound.currentTime = 0;
                        successSound.play();
                    } else if (randomItem.type === 'rare') {
                        points += 50;
                        pointsDisplay.textContent = points;
                        chimeSound.currentTime = 0;
                        chimeSound.play();
                    } else {
                        // Corrupted item - screen shake
                        document.body.classList.add('glitch');
                        setTimeout(() => {
                            document.body.classList.remove('glitch');
                        }, 500);
                        glitchSound.currentTime = 0;
                        glitchSound.play();
                    }
                }
                
                // Remove if out of bounds
                if (currentTop > gameContainer.offsetHeight) {
                    clearInterval(fallInterval);
                    item.remove();
                }
            }, 20);
        }
        
        // Move basket with mouse
        function moveBasket(e) {
            if (currentStage !== 5) return;
            
            const containerRect = gameContainer.getBoundingClientRect();
            let mouseX = e.clientX - containerRect.left;
            
            // Keep basket within container bounds
            mouseX = Math.max(0, Math.min(mouseX, containerRect.width - basket.offsetWidth));
            
            basket.style.left = `${mouseX}px`;
        }
        
        // Move basket with keyboard
        function moveBasketLeft() {
            if (currentStage !== 5) return;
            
            const currentLeft = parseInt(basket.style.left) || (gameContainer.offsetWidth / 2 - basket.offsetWidth / 2);
            const newLeft = Math.max(0, currentLeft - 20);
            basket.style.left = `${newLeft}px`;
        }
        
        function moveBasketRight() {
            if (currentStage !== 5) return;
            
            const currentLeft = parseInt(basket.style.left) || (gameContainer.offsetWidth / 2 - basket.offsetWidth / 2);
            const newLeft = Math.min(gameContainer.offsetWidth - basket.offsetWidth, currentLeft + 20);
            basket.style.left = `${newLeft}px`;
        }
        
        // Start the questionnaire in stage 6
        function startQuestionnaire() {
            futureIntentConfirmed = false;
            questionTimeLeft = 20;
            questionTimer.textContent = questionTimeLeft;
            questionnaire.innerHTML = '';
            
            // Start ice effect
            iceSound.play();
            iceOverlay.classList.add('active');
            
            // Display questions one by one
            let questionIndex = 0;
            const questionInterval = setInterval(() => {
                if (questionIndex < questions.length) {
                    displayQuestion(questions[questionIndex]);
                    questionIndex++;
                } else {
                    clearInterval(questionInterval);
                }
            }, 4000); // Show a new question every 4 seconds
            
            // Start timer
            questionnaireTimer = setInterval(() => {
                questionTimeLeft--;
                questionTimer.textContent = questionTimeLeft;
                
                if (questionTimeLeft <= 0) {
                    clearInterval(questionnaireTimer);
                    endQuestionnaire();
                }
            }, 1000);
        }
        
        // Display a single question
        function displayQuestion(questionText) {
            // Clear previous question
            questionnaire.innerHTML = '';
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            
            const questionP = document.createElement('p');
            questionP.textContent = questionText;
            questionDiv.appendChild(questionP);
            
            const yesBtn = document.createElement('button');
            yesBtn.className = 'btn';
            yesBtn.textContent = 'Yes';
            yesBtn.addEventListener('click', () => {
                futureIntentConfirmed = true;
                endQuestionnaire();
            });
            
            const noBtn = document.createElement('button');
            noBtn.className = 'btn';
            noBtn.textContent = 'No';
            noBtn.addEventListener('click', () => {
                // Just continue to next question
            });
            
            questionDiv.appendChild(yesBtn);
            questionDiv.appendChild(noBtn);
            
            questionnaire.appendChild(questionDiv);
        }
        
        // End the questionnaire
        function endQuestionnaire() {
            clearInterval(questionnaireTimer);
            
            if (futureIntentConfirmed) {
                // Ice shatters
                iceSound.pause();
                shatterSound.play();
                iceCrack.classList.add('active');
                
                setTimeout(() => {
                    iceOverlay.classList.remove('active');
                    iceCrack.classList.remove('active');
                    
                    // Move to next stage
                    setTimeout(() => {
                        moveToStage(7);
                    }, 1000);
                }, 1000);
            } else {
                // Screen freezes completely
                setTimeout(() => {
                    document.body.style.filter = 'blur(3px)';
                    
                    setTimeout(() => {
                        document.body.style.filter = 'none';
                        iceOverlay.classList.remove('active');
                        
                        // Move to next stage
                        moveToStage(7);
                    }, 1500);
                }, 1000);
            }
        }
        
        // Calculate and display reward in stage 7
        function calculateReward() {
            finalScore.textContent = points;
            
            if (futureIntentConfirmed) {
                futureIntentItem.style.display = 'flex';
                rewardMessage.textContent = "Congratulations! You've unlocked the 30% loyalty bonus!";
                rewardMessage.className = "success";
            } else {
                standardRebateItem.style.display = 'flex';
                rewardMessage.textContent = "Standard reward applied. Every little bit helps!";
            }
            
            // Move to next stage after a delay
            setTimeout(() => {
                moveToStage(8);
            }, 4000);
        }
        
        // Start system sync in stage 8
        function startSystemSync() {
            let syncProgressValue = 0;
            const syncInterval = setInterval(() => {
                syncProgressValue += 0.5;
                syncProgress.style.width = `${syncProgressValue}%`;
                
                // Update messages based on progress
                if (syncProgressValue < 25) {
                    syncMessage.textContent = futureIntentConfirmed ? 
                        "Syncing your 30% discount... a wise choice." : 
                        "Applying your... generous 0.1% rebate. Every little bit helps.";
                } else if (syncProgressValue < 50) {
                    syncMessage.textContent = "You've been here a while. We appreciate your... cooperation.";
                } else if (syncProgressValue < 75) {
                    syncMessage.textContent = "The system is now stable. Feel free to browse our actual products.";
                } else {
                    syncMessage.textContent = "Finalizing your reality... please hold.";
                }
                
                // Gradually reduce glitch effects and transition to clean design
                if (syncProgressValue > 50) {
                    fanSound.volume = Math.max(0, 0.3 - (syncProgressValue - 50) / 50);
                    staticOverlay.style.opacity = Math.max(0, 0.1 - (syncProgressValue - 50) / 100);
                }
                
                if (syncProgressValue > 80) {
                    document.body.classList.add('stable');
                }
                
                if (syncProgressValue >= 100) {
                    clearInterval(syncInterval);
                    
                    // Show final message and redirect
                    setTimeout(() => {
                        document.getElementById('stage8').innerHTML = `
                            <h1>SYNC COMPLETE</h1>
                            <div class="message-box">
                                <p>Thank you for your participation.</p>
                                <p>Redirecting to our store...</p>
                            </div>
                        `;
                        
                        // In a real implementation, this would redirect to your website
                        setTimeout(() => {
                            alert("Redirecting to https://notthebestplacetobuystuff.in...");
                            // window.location.href = "https://notthebestplacetobuystuff.in";
                        }, 2000);
                    }, 1000);
                }
            }, 100); // 4 minutes total (240 seconds) would be 24000ms, but we're speeding it up for demo
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>
